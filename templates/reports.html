

{% extends "base.html" %}

{% block title %}Reports - AutoTestify{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="text-center mb-5 animate__animated animate__fadeInDown">
        <h2 class="display-5 fw-bold bg-gradient text-primary">
            <i class="fas fa-chart-line text-info me-3 pulse"></i>Analysis Reports
        </h2>
        <p class="lead text-muted">View and download your generated analysis reports</p>
        <div class="badge bg-primary-subtle text-primary px-3 py-2 rounded-pill">
            <i class="fas fa-file-alt me-1"></i>{{ reports|length }} Report{{ 's' if reports|length != 1 else '' }}
        </div>
    </div>

    {% if reports %}
    <div class="row g-3 g-md-4">
        {% for report in reports %}
        <div class="col-12 col-md-6 col-xl-4 animate__animated animate__fadeInUp" style="animation-delay: {{ loop.index0 * 0.1 }}s;">
            <div class="card border-0 shadow-sm h-100 hover-lift">
                <div class="card-body d-flex flex-column">
                    {% if report.selenium_ui %}
                    <div class="mb-2">
                        <span class="badge bg-info text-dark">
                            <i class="fas fa-robot me-1"></i>UI Verified
                        </span>
                    </div>
                    {% endif %}

                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div class="flex-grow-1 me-2">
                            <h6 class="card-title mb-2 text-gradient fw-bold">
                                <i class="fas fa-file-alt text-info me-2"></i>
                                {{ report.filename.replace('.html', '').replace('_', ' ').title() }}
                            </h6>
                            <div class="d-flex flex-wrap gap-2 mb-2">
                                <span class="badge bg-light text-dark">
                                    <i class="fas fa-calendar me-1 text-success"></i>
                                    {{ report.timestamp.strftime('%m/%d/%y %I:%M%p') }}
                                </span>
                                <span class="badge bg-light text-dark">
                                    <i class="fas fa-file-code me-1 text-warning"></i>
                                    {{ "%.1f"|format(report.size / 1024) }}KB
                                </span>
                            </div>
                        </div>
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary btn-sm rounded-circle" type="button" data-bs-toggle="dropdown">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end shadow border-0">
                                <li><a class="dropdown-item" href="{{ url_for('view_report', filename=report.filename) }}" target="_blank">
                                    <i class="fas fa-eye me-2 text-primary"></i>View
                                </a></li>
                                <li><a class="dropdown-item" href="{{ url_for('download_report', filename=report.filename) }}">
                                    <i class="fas fa-download me-2 text-success"></i>Download
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" href="#" onclick="deleteReport('{{ report.filename }}')">
                                    <i class="fas fa-trash me-2"></i>Delete
                                </a></li>
                            </ul>
                        </div>
                    </div>

                    {# Selenium UI Checks Summary (Collapsible) #}
                    {% if selenium_ui %}
                    <div class="accordion mb-3" id="accordion-{{ loop.index }}">
                        <div class="accordion-item border">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#collapse-{{ loop.index }}" aria-expanded="false">
                                    <i class="fas fa-eye me-2 text-info"></i>Repository UI Validation Summary
                                </button>
                            </h2>
                            <div id="collapse-{{ loop.index }}" class="accordion-collapse collapse">
                                <div class="accordion-body small">
                                    <ul class="list-unstyled mb-2">
                                        <li>
                                            <i class="fas fa-check-circle text-success me-2"></i>
                                            README.md Present:
                                            <strong>{{ 'Yes' if report.selenium_ui.readme_present else 'No' }}</strong>
                                        </li>
                                        <li>
                                            <i class="fas fa-check-circle text-success me-2"></i>
                                            CI/CD Badge Detected:
                                            <strong>{{ 'Yes' if report.selenium_ui.ci_badge_present else 'No' }}</strong>
                                        </li>
                                        <li>
                                            <i class="fas fa-check-circle text-success me-2"></i>
                                            Actions Tab Visible:
                                            <strong>{{ 'Yes' if report.selenium_ui.actions_tab_visible else 'No' }}</strong>
                                        </li>
                                    </ul>

                                    {% if selenium_ui.screenshot_path %}
                                    <div class="mt-3">
                                        <p class="mb-1 fw-bold">Screenshot:</p>
                                        <a href="{{ url_for('screenshots', filename=selenium_ui.screenshot_path) }}" target="_blank">
                                            <img src="{{ url_for('screenshots', filename=selenium_ui.screenshot_path) }}"
                                                class="img-thumbnail" style="max-width: 100%;" alt="Screenshot">
                                        </a>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <div class="d-flex gap-2 mt-auto">
                        <a href="{{ url_for('view_report', filename=report.filename) }}" class="btn btn-primary btn-sm flex-fill" target="_blank">
                            <i class="fas fa-eye me-1"></i>View
                        </a>
                        <a href="{{ url_for('download_report', filename=report.filename) }}" class="btn btn-success btn-sm flex-fill">
                            <i class="fas fa-download me-1"></i>Download
                        </a>
                        <button class="btn btn-outline-danger btn-sm" onclick="deleteReport('{{ report.filename }}')" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>

                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-5 animate__animated animate__fadeIn">
        <div class="mb-4 empty-state-icon">
            <i class="fas fa-folder-open text-muted pulse-slow" style="font-size: 4rem;"></i>
        </div>
        <h4 class="text-muted mb-3">No Reports Generated Yet</h4>
        <p class="text-muted mb-4">Start analyzing repositories or testing APIs to generate your first report.</p>
        <div class="d-flex flex-column flex-sm-row gap-3 justify-content-center align-items-center">
            <a href="{{ url_for('github_analysis') }}" class="btn btn-primary btn-lg hover-scale w-100 w-sm-auto">
                <i class="fab fa-github me-2"></i>Analyze Repository
            </a>
            <a href="{{ url_for('api_testing') }}" class="btn btn-success btn-lg hover-scale w-100 w-sm-auto">
                <i class="fas fa-code me-2"></i>Test APIs
            </a>
        </div>
    </div>
    {% endif %}
</div>

<style>
.hover-lift,.hover-scale,.bounce-on-hover{transition:transform .2s ease}
.text-gradient{background:linear-gradient(45deg,#007bff,#6f42c1);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.hover-bg-primary:hover{background-color:rgba(13,110,253,.1)!important}
.hover-bg-success:hover{background-color:rgba(25,135,84,.1)!important}
.hover-bg-danger:hover{background-color:rgba(220,53,69,.1)!important}
.pulse{animation:pulse 2s infinite}
.empty-state-icon{animation:float 3s ease-in-out infinite}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
@media(min-width:768px){
.hover-lift:hover{transform:translateY(-3px);box-shadow:0 4px 15px rgba(0,0,0,.1)!important}
.hover-scale:hover{transform:scale(1.02)}
.bounce-on-hover:hover{transform:translateY(-1px)}
}
@media(max-width:767px){
.card-body{padding:.75rem}
.btn-sm{font-size:.8rem;padding:.25rem .5rem}
.badge{font-size:.7rem}
.animate__animated{animation-duration:.5s}
}
.deleting{transition:all .3s ease;pointer-events:none}
</style>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" media="screen" loading="lazy">

<script>
function deleteReport(filename) {
    if (confirm('üóëÔ∏è Delete this report?\n\nThis cannot be undone.')) {
        const button = event.target.closest('button');
        const card = button.closest('.col-12, .col-md-6, .col-xl-4');
        const originalHTML = button.innerHTML;
        
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        button.disabled = true;
        card.style.opacity = '0.6';
        card.style.pointerEvents = 'none';
        
        fetch('/api/delete-report', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({filename: filename})
        })
        .then(response => {
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return response.json();
        })
        .then(data => {
            if (data.success) {
                card.style.transform = 'scale(0.8)';
                card.style.opacity = '0';
                setTimeout(() => card.remove(), 300);
                
                // Update count if exists
                const countBadge = document.querySelector('.badge');
                if (countBadge) {
                    const currentCount = parseInt(countBadge.textContent.match(/\d+/)[0]);
                    const newCount = currentCount - 1;
                    countBadge.innerHTML = `<i class="fas fa-file-alt me-1"></i>${newCount} Report${newCount !== 1 ? 's' : ''}`;
                    
                    if (newCount === 0) {
                        setTimeout(() => location.reload(), 500);
                    }
                }
            } else {
                throw new Error(data.error || 'Delete failed');
            }
        })
        .catch(error => {
            console.error('Delete error:', error);
            alert('‚ùå Failed to delete: ' + error.message);
            button.innerHTML = originalHTML;
            button.disabled = false;
            card.style.opacity = '1';
            card.style.pointerEvents = 'auto';
        });
    }
}
</script>
{% endblock %}
