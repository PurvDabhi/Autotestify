<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AutoTestify - API Testing Report</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <style>
      .report-header {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        padding: 2rem;
      }
      .metric-card {
        border: none;
        border-left: 4px solid #007bff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .status-success {
        border-left-color: #28a745;
      }
      .status-warning {
        border-left-color: #ffc107;
      }
      .status-danger {
        border-left-color: #dc3545;
      }
      .chart-container {
        min-height: 400px;
        margin: 1rem 0;
        width: 100%;
        overflow: hidden;
        position: relative;
      }
      
      /* Responsive Design Improvements */
      @media (max-width: 1200px) {
        .chart-container {
          min-height: 350px;
        }
      }
      
      @media (max-width: 992px) {
        .chart-container {
          min-height: 320px;
        }
      }
      
      @media (max-width: 768px) {
        .container-fluid {
          padding-left: 15px;
          padding-right: 15px;
        }
        
        .chart-container {
          min-height: 300px;
        }
        
        .report-header {
          padding: 1.5rem;
        }
        
        .report-header h1 {
          font-size: 1.5rem;
        }
        
        .report-header h2 {
          font-size: 1.25rem;
        }
      }
      
      @media (max-width: 576px) {
        .col-lg-6 {
          margin-bottom: 1rem;
        }
        
        .chart-container {
          min-height: 280px;
        }
        
        .card-header {
          padding: 1rem;
        }
        
        .card-body {
          padding: 1rem;
        }
      }
      
      @media (max-width: 480px) {
        .chart-container {
          min-height: 250px;
        }
        
        .report-header h1 {
          font-size: 1.25rem;
        }
        
        .report-header h2 {
          font-size: 1.1rem;
        }
      }
      .endpoint-card {
        border-left: 4px solid #6c757d;
        transition: all 0.3s ease;
      }
      .endpoint-card.success {
        border-left-color: #28a745;
      }
      .endpoint-card.error {
        border-left-color: #dc3545;
      }
      .performance-grade-A {
        color: #28a745;
        font-weight: bold;
      }
      .performance-grade-B {
        color: #17a2b8;
        font-weight: bold;
      }
      .performance-grade-C {
        color: #ffc107;
        font-weight: bold;
      }
      .performance-grade-D {
        color: #fd7e14;
        font-weight: bold;
      }
      .performance-grade-F {
        color: #dc3545;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div class="report-header text-center">
      <h1><i class="fas fa-code me-3"></i>API Testing Report</h1>
      <h2>{{ base_url }}</h2>
      <p class="mb-0">
        Generated on {{ generated_at.strftime('%B %d, %Y at %I:%M %p') }}
      </p>
    </div>

    <div class="container-fluid py-4">
      <!-- Testing Overview -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h3>
                <i class="fas fa-tachometer-alt me-2"></i>Testing Overview
              </h3>
            </div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-3">
                  <div class="card metric-card status-success text-center">
                    <div class="card-body p-3">
                      <h4 class="text-success">
                        {{ test_results.successful_tests }}
                      </h4>
                      <small>Successful Tests</small>
                    </div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="card metric-card status-danger text-center">
                    <div class="card-body p-3">
                      <h4 class="text-danger">
                        {{ test_results.failed_tests }}
                      </h4>
                      <small>Failed Tests</small>
                    </div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="card metric-card status-warning text-center">
                    <div class="card-body p-3">
                      <h4 class="text-info">
                        {{
                        "%.1f"|format(test_results.performance_metrics.average_response_time)
                        }}ms
                      </h4>
                      <small>Avg Response Time</small>
                    </div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="card metric-card text-center">
                    <div class="card-body p-3">
                      <h4 class="text-primary">
                        {{ test_results.total_endpoints }}
                      </h4>
                      <small>Total Endpoints</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Security Analysis -->
      {% if test_results.security_analysis %}
      <div class="row mb-4">
        <div class="col-12">
          <div class="card">
            <div
              class="card-header d-flex justify-content-between align-items-center"
            >
              <h3><i class="fas fa-shield-alt me-2"></i>Security Analysis</h3>
              <div
                class="badge bg-{% if test_results.security_analysis.security_grade == 'A' %}success{% elif test_results.security_analysis.security_grade == 'B' %}primary{% elif test_results.security_analysis.security_grade == 'C' %}warning{% else %}danger{% endif %} fs-6"
              >
                Grade: {{ test_results.security_analysis.security_grade }}
              </div>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-4">
                  <h6>HTTPS Usage</h6>
                  <p
                    class="text-{% if test_results.security_analysis.https_usage %}success{% else %}danger{% endif %}"
                  >
                    <i
                      class="fas fa-{% if test_results.security_analysis.https_usage %}check{% else %}times{% endif %} me-2"
                    ></i>
                    {% if test_results.security_analysis.https_usage %}Enabled{%
                    else %}Not Detected{% endif %}
                  </p>
                </div>
                <div class="col-md-4">
                  <h6>Security Headers</h6>
                  <p class="text-info">
                    <i class="fas fa-info-circle me-2"></i>
                    {{ test_results.security_analysis.security_headers_present
                    }} headers found
                  </p>
                </div>
                <div class="col-md-4">
                  <h6>Overall Security</h6>
                  <p
                    class="text-{% if test_results.security_analysis.security_grade in ['A', 'B'] %}success{% elif test_results.security_analysis.security_grade == 'C' %}warning{% else %}danger{% endif %}"
                  >
                    <i class="fas fa-star me-2"></i>
                    Grade {{ test_results.security_analysis.security_grade }}
                  </p>
                </div>
              </div>

              {% if test_results.security_analysis.recommendations %}
              <div class="mt-3">
                <h6>Security Recommendations</h6>
                <ul class="list-unstyled">
                  {% for recommendation in
                  test_results.security_analysis.recommendations %}
                  <li>
                    <i class="fas fa-arrow-right text-primary me-2"></i>{{
                    recommendation }}
                  </li>
                  {% endfor %}
                </ul>
              </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Charts Section -->
      {% if charts %}
      <div class="row mb-4">
        {% if charts.response_times %}
        <div class="col-lg-6 mb-4">
          <div class="card">
            <div class="card-header">
              <h5><i class="fas fa-chart-bar me-2"></i>Response Times</h5>
            </div>
            <div class="card-body">
              <div id="responseTimeChart" class="chart-container"></div>
            </div>
          </div>
        </div>
        {% endif %} {% if charts.status_codes %}
        <div class="col-lg-6 mb-4">
          <div class="card">
            <div class="card-header">
              <h5>
                <i class="fas fa-chart-pie me-2"></i>Status Code Distribution
              </h5>
            </div>
            <div class="card-body">
              <div id="statusCodeChart" class="chart-container"></div>
            </div>
          </div>
        </div>
        {% endif %} {% if charts.performance_grades %}
        <div class="col-12 mb-4">
          <div class="card">
            <div class="card-header">
              <h5><i class="fas fa-trophy me-2"></i>Performance Grades</h5>
            </div>
            <div class="card-body">
              <div id="performanceGradeChart" class="chart-container"></div>
            </div>
          </div>
        </div>
        {% endif %}
      </div>
      {% endif %}

      <!-- Endpoint Details -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h3><i class="fas fa-list me-2"></i>Endpoint Test Results</h3>
            </div>
            <div class="card-body">
              <div class="row g-3">
                {% for endpoint in test_results.endpoint_results %}
                <div class="col-lg-6">
                  <div
                    class="card endpoint-card {% if endpoint.success %}success{% else %}error{% endif %}"
                  >
                    <div class="card-body">
                      <div
                        class="d-flex justify-content-between align-items-start mb-2"
                      >
                        <h6 class="card-title mb-0">
                          <span
                            class="badge bg-{% if endpoint.method == 'GET' %}primary{% elif endpoint.method == 'POST' %}success{% elif endpoint.method == 'PUT' %}warning{% elif endpoint.method == 'DELETE' %}danger{% else %}secondary{% endif %} me-2"
                          >
                            {{ endpoint.method }}
                          </span>
                          {{ endpoint.endpoint }}
                        </h6>
                        <div class="d-flex align-items-center gap-2">
                          <span
                            class="performance-grade-{{ endpoint.performance_grade }}"
                            >{{ endpoint.performance_grade }}</span
                          >
                          {% if endpoint.success %}
                          <i class="fas fa-check-circle text-success"></i>
                          {% else %}
                          <i class="fas fa-times-circle text-danger"></i>
                          {% endif %}
                        </div>
                      </div>

                      <div class="row g-2 mb-2">
                        <div class="col-6">
                          <small class="text-muted">Status Code:</small>
                          <div
                            class="fw-bold text-{% if endpoint.status_code and 200 <= endpoint.status_code < 300 %}success{% elif endpoint.status_code and 400 <= endpoint.status_code < 500 %}warning{% elif endpoint.status_code and endpoint.status_code >= 500 %}danger{% else %}muted{% endif %}"
                          >
                            {{ endpoint.status_code or 'N/A' }}
                          </div>
                        </div>
                        <div class="col-6">
                          <small class="text-muted">Response Time:</small>
                          <div class="fw-bold">
                            {{ endpoint.response_time }}ms
                          </div>
                        </div>
                      </div>

                      {% if endpoint.content_type %}
                      <div class="mb-2">
                        <small class="text-muted">Content Type:</small>
                        <div class="small">{{ endpoint.content_type }}</div>
                      </div>
                      {% endif %} {% if endpoint.error %}
                      <div class="alert alert-danger py-2 mb-0">
                        <small
                          ><i class="fas fa-exclamation-triangle me-1"></i>{{
                          endpoint.error }}</small
                        >
                      </div>
                      {% endif %} {% if endpoint.security_headers %}
                      <div class="mt-2">
                        <small class="text-muted"
                          >Security Headers: {{ endpoint.security_headers|length
                          }}</small
                        >
                      </div>
                      {% endif %}
                    </div>
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Performance Summary -->
      {% if test_results.performance_metrics.fastest_endpoint and
      test_results.performance_metrics.slowest_endpoint %}
      <div class="row">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header bg-success text-white">
              <h5 class="mb-0">
                <i class="fas fa-rocket me-2"></i>Fastest Endpoint
              </h5>
            </div>
            <div class="card-body">
              <h6>
                {{ test_results.performance_metrics.fastest_endpoint.endpoint }}
              </h6>
              <p class="text-success mb-0">
                <strong
                  >{{
                  test_results.performance_metrics.fastest_endpoint.response_time
                  }}ms</strong
                >
              </p>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card">
            <div class="card-header bg-warning text-dark">
              <h5 class="mb-0">
                <i class="fas fa-snail me-2"></i>Slowest Endpoint
              </h5>
            </div>
            <div class="card-body">
              <h6>
                {{ test_results.performance_metrics.slowest_endpoint.endpoint }}
              </h6>
              <p class="text-warning mb-0">
                <strong
                  >{{
                  test_results.performance_metrics.slowest_endpoint.response_time
                  }}ms</strong
                >
              </p>
            </div>
          </div>
        </div>
      </div>
      {% endif %}
    </div>

    <script>
      // Render charts with full responsive configuration
      function renderChart(elementId, chartData) {
        try {
          var config = {
            responsive: true,
            displayModeBar: false,
            toImageButtonOptions: {
              format: 'png',
              filename: 'chart',
              height: 400,
              width: 600,
              scale: 1
            }
          };
          
          // Ensure layout is fully responsive
          if (chartData.layout) {
            chartData.layout.autosize = true;
            chartData.layout.responsive = true;
            
            // Adjust margins for mobile
            if (window.innerWidth <= 768) {
              chartData.layout.margin = {l: 30, r: 30, t: 40, b: 40};
              chartData.layout.height = 300;
            } else if (window.innerWidth <= 576) {
              chartData.layout.margin = {l: 20, r: 20, t: 35, b: 35};
              chartData.layout.height = 280;
            }
            
            // Adjust font sizes for mobile
            if (window.innerWidth <= 576) {
              chartData.layout.font = {size: 10};
              if (chartData.layout.title) {
                chartData.layout.title.font = {size: 12};
              }
            }
          }
          
          Plotly.newPlot(elementId, chartData.data, chartData.layout, config);
          
        } catch(e) {
          console.error('Error rendering chart for ' + elementId + ':', e);
          document.getElementById(elementId).innerHTML = '<div class="alert alert-warning">Chart could not be loaded</div>';
        }
      }
      
      // Handle window resize with debouncing
      let resizeTimeout;
      function handleResize() {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(function() {
          ['responseTimeChart', 'statusCodeChart', 'performanceGradeChart'].forEach(function(chartId) {
            var element = document.getElementById(chartId);
            if (element && element.data) {
              Plotly.Plots.resize(chartId);
            }
          });
        }, 250);
      }
      
      document.addEventListener('DOMContentLoaded', function() {
        {% if charts.response_times %}
        var responseTimeData = {{ charts.response_times|safe }};
        renderChart('responseTimeChart', responseTimeData);
        {% endif %}

        {% if charts.status_codes %}
        var statusCodeData = {{ charts.status_codes|safe }};
        renderChart('statusCodeChart', statusCodeData);
        {% endif %}

        {% if charts.performance_grades %}
        var performanceGradeData = {{ charts.performance_grades|safe }};
        renderChart('performanceGradeChart', performanceGradeData);
        {% endif %}
        
        // Add resize listener
        window.addEventListener('resize', handleResize);
      });
    </script>
  </body>
</html>


